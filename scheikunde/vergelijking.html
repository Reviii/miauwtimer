<html>
<head>
<title>Vergelijking v0.1.4</title>
</head>
<body>
<input id="f" value="NH3+O2>N2+H2O" style="width:50%"><button onclick="solve()">Los op</button><p id="output"></p>
<script>
function solve()  {
    var f = document.getElementById("f").value;
    f = f.split(" ").join("").split("-").join("").split(">")
    if (!f[1]) alert("Error: een deel van de reactievergelijking mist")
    f[0] = f[0].split("+")
    f[1] = f[1].split("+")
    f[0] = f[0].map(splitElement)
    f[1] = f[1].map(splitElement)
    var e = [];
    e[0] = getElementArray(f[0])
    e[1] = getElementArray(f[1])
    var fold, foldnew;
    foldnew = JSON.stringify(f)
    var i = 0;
    while (fold != foldnew) {
    fold = foldnew;
    lcmsolve()
    foldnew = JSON.stringify(f)
    i++
    if (i > 20) {
        alert("Can't solve")
        fold = foldnew
    }
    }
    displayF(f)
    function lcmsolve() {
      var i, j;
      for (i in e[0]) {
        if (e[0][i].length<2) {
          if (e[1][i]) {
            if (2>e[1][i].length) {
              let a = lcm(f[1][e[1][i][0]][i]*f[1][e[1][i][0]].a, f[0][e[0][i][0]][i]*f[0][e[0][i][0]].a)
              f[1][e[1][i][0]].a = a/f[1][e[1][i][0]][i]
              f[0][e[0][i][0]].a = a/f[0][e[0][i][0]][i]
            }
          }
        }
      }
      for (i in e[1]) {
        if (e[1][i].length<2) {
          if (e[0][i]) {
            if (2>e[0][i].length) {
              let a = lcm(f[0][e[0][i][0]][i]*f[0][e[0][i][0]].a, f[1][e[1][i][0]][i]*f[1][e[1][i][0]].a)
              f[0][e[0][i][0]].a = a/f[0][e[0][i][0]][i]
              f[1][e[1][i][0]].a = a/f[1][e[1][i][0]][i]
            }
          }
        }
      }
    }
}
function splitElement(element) {
    var obj = {a: 1};
    var objarr = element.split(/(?=[A-Z])/).map(splitKat)
    for (var i=0;i<objarr.length;i++) {
      for (j in objarr[i]) {
        obj[j] = objarr[i][j]
      }
    }
    return obj
}
function splitKat(kat) {
    // kat = kat.split(/(?=(?<![0-9])[0-9])/) // Werkt niet op alle apparaten, dus hieronder komt de minder mooie oplossing
    var arr=[""]
    kat=kat.split("")
    for (var i=0;i<kat.length;i++) {
    if (kat[i].match(/[0-9]/)) break
      arr[0] += kat[i]
    }
    arr[1]=kat.slice(i).join("");
    kat=arr // einde minder mooie oplossing
    if (!kat[1]) kat[1]=1
    kat[1]=Number(kat[1])
    var obj = {}
    obj[kat[0]] = kat[1]
    return obj
}
function getElementArray(f) {
var i, j, k
var e = {}
for (i=0;i<f.length;i++) {
for (k in f[i]) {
if (k=="a") continue;
if (e[k]) {
e[k][e[k].length] = i; alert("Vergelijking is te moeilijk: \nEr kunnen geen oplossingen worden gevonden voor "+k)
} else {
e[k] = []
e[k][0] = i
}
}
}
return e
}
function gcd(a, b) {
    var t = b;
    while (b != 0 && !Number.isNaN(b)) {
       t = b; 
       b = a % b; 
       a = t;
    } 
    return a;
}
function lcm(a, b) {
    return Math.abs(a)*Math.abs(b)/gcd(a, b)
}
function displayF(f) {
    document.getElementById("output").innerHTML = f[0].map(joinElement).join(" + ")+" &rarr; "+f[1].map(joinElement).join(" + ")
}
function joinElement(element) {
    var str=""
    for (var i in element) {
      if (i != "a") {
        element[i] = element[i].toString()
        element[i] = "<sub>"+element[i]+"</sub>"
        if (element[i] == "<sub>1</sub>") element[i]=""
        str += i + element[i]
      }
    }
    if (element.a=="1" || !element.a) element.a=""
    return element.a+str
}
</script>
</body>
</html>
